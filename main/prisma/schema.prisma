// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Session {
  id            Int      @id @default(autoincrement())
  dcId          Int?
  port          Int?
  serverAddress String?
  authKey       Bytes?
  entities      Entity[]
}

model Entity {
  id        Int     @id @default(autoincrement())
  /// 源代码里面大概支持 string 和 BigInteger，不如先全都存 String
  entityId  String
  sessionId Int
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  hash      String?
  username  String?
  phone     String?
  name      String?

  @@unique([entityId, sessionId])
}

model Instance {
  id            Int           @id @default(autoincrement())
  owner         BigInt        @default(0)
  workMode      String        @default("")
  isSetup       Boolean       @default(false)
  Message       Message[]
  ForwardPair   ForwardPair[]
  QQRequest     QQRequest[]   // Phase 3: 请求处理
  AutomationRule      AutomationRule[]        // Phase 4: 自动化规则
  RequestStatistics   RequestStatistics?      // Phase 4: 请求统计
  botSessionId  Int?
  userSessionId Int?
  qqBotId       Int?
  qqBot         QqBot?        @relation(fields: [qqBotId], references: [id], onDelete: Cascade)
  flags         Int           @default(0)
}

enum QqBotType {
  oicq
  napcat
}

model QqBot {
  id           Int        @id @default(autoincrement())
  uin          BigInt?    @default(0)
  password     String?    @default("")
  platform     Int?       @default(0)
  Instance     Instance[]
  signApi      String?
  signVer      String?
  signDockerId String?
  type         QqBotType  @default(oicq)
  wsUrl        String?
}

model Message {
  id             Int      @id @default(autoincrement())
  qqRoomId       BigInt   @db.BigInt
  qqSenderId     BigInt   @db.BigInt
  time           Int
  brief          String?
  seq            Int
  rand           BigInt   @db.BigInt
  pktnum         Int
  tgChatId       BigInt   @db.BigInt
  tgMsgId        Int
  instanceId     Int      @default(0)
  instance       Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  tgFileId       BigInt?  @db.BigInt
  tgMessageText  String?
  nick           String? /// /抱 的时候会用到
  tgSenderId     BigInt?  @db.BigInt
  richHeaderUsed Boolean  @default(false)
  ignoreDelete   Boolean  @default(false) /// rmq rmt

  @@index([qqRoomId, qqSenderId, seq, rand, pktnum, time, instanceId])
  @@index([tgChatId, tgMsgId, instanceId])
}

model ForwardPair {
  id              Int               @id @default(autoincrement())
  qqRoomId        BigInt            @db.BigInt
  qqFromGroupId   BigInt?           @db.BigInt /// 用于群临时
  tgChatId        BigInt            @db.BigInt
  tgThreadId      Int?              /// Telegram 话题 ID (Forum Topic ID)
  avatarCache     AvatarCache[]
  instanceId      Int               @default(0)
  instance        Instance          @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  flags           Int               @default(0)
  ignoreRegex     String?           /// 正则表达式，用于忽略匹配该正则的 QQ 消息 (防止循环转发)
  ignoreSenders   String?           /// 忽略的 QQ 发送者 ID 列表 (逗号分隔)
  forwardMode     String?           /// 转发方向配置: "00"=全禁用, "01"=仅TG→QQ, "10"=仅QQ→TG, "11"=双向 (null=使用环境变量默认值)
  nicknameMode    String?           /// 昵称显示配置: 同上格式 (null=使用环境变量默认值)
  apiKey          String            @unique @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ForwardMultiple ForwardMultiple[]

  @@unique([qqRoomId, instanceId])
  @@unique([tgChatId, tgThreadId, instanceId])
}

model File {
  id     Int     @id @default(autoincrement())
  roomId BigInt  @db.BigInt
  fileId String
  info   String
  name   String?
}

model FlashPhoto {
  id       Int              @id @default(autoincrement())
  photoMd5 String
  views    FlashPhotoView[]
}

model FlashPhotoView {
  id           Int        @id @default(autoincrement())
  flashPhotoId Int
  flashPhoto   FlashPhoto @relation(fields: [flashPhotoId], references: [id])
  viewerId     BigInt     @db.BigInt

  @@unique([flashPhotoId, viewerId])
}

model AvatarCache {
  id            Int         @id @default(autoincrement())
  forwardPair   ForwardPair @relation(fields: [forwardPairId], references: [id], onDelete: Cascade)
  forwardPairId Int         @unique
  hash          Bytes
}

model ForwardMultiple {
  id         String      @id @default(dbgenerated("gen_random_uuid()"))  @db.Uuid
  resId      String
  fileName   String
  fromPairId Int
  fromPair   ForwardPair @relation(fields: [fromPairId], references: [id], onDelete: Cascade)
}

// ============================================
// 管理后台认证模型
// ============================================

// 管理员用户表
model AdminUser {
  id           Int             @id @default(autoincrement())
  username     String          @unique
  passwordHash String          // bcrypt hash
  displayName  String?
  email        String?
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  sessions     AdminSession[]
  auditLogs    AdminAuditLog[]

  @@index([username])
}

// 管理员会话表（用于 remember me 功能）
model AdminSession {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    Int
  user      AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique // session token
  expiresAt DateTime
  createdAt DateTime  @default(now())
  ipAddress String?
  userAgent String?

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// Access Token 表（用于 API 访问，可独立于用户存在）
model AccessToken {
  id          Int       @id @default(autoincrement())
  token       String    @unique
  description String?   // token 用途描述
  isActive    Boolean   @default(true)
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  createdBy   Int?      // 可以为 null，表示系统生成
  lastUsedAt  DateTime?

  @@index([token])
  @@index([isActive])
}

// 审计日志
model AdminAuditLog {
  id         Int        @id @default(autoincrement())
  userId     Int?
  user       AdminUser? @relation(fields: [userId], references: [id], onDelete: SetNull)
  action     String     // 'login', 'logout', 'create_pair', 'delete_pair', etc.
  resource   String?    // 'pair', 'instance', etc.
  resourceId String?    // 资源 ID
  details    Json?      // 详细信息
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime   @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// 全局配置表（可选，用于存储运行时配置）
model GlobalConfig {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   Int?

  @@index([key])
}

// ============================================
// Phase 3: QQ请求处理模型
// ============================================

model QQRequest {
  id          Int      @id @default(autoincrement())
  instanceId  Int
  instance    Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  
  // 请求基本信息
  flag        String   @unique  // OneBot标识符
  type        String   // 'friend' | 'group'
  subType     String?  // 'add' | 'invite' (仅群请求)
  
  // 用户信息
  userId      BigInt   @db.BigInt
  groupId     BigInt?  @db.BigInt  // 仅群请求
  comment     String?  // 验证消息
  
  // 状态信息
  status      String   @default("pending")  // 'pending' | 'approved' | 'rejected'
  handledBy   BigInt?  @db.BigInt  // Telegram操作者ID
  handledAt   DateTime?
  rejectReason String?  // 拒绝理由
  
  // 时间戳
  createdAt   DateTime @default(now())
  
  @@index([instanceId, status])
  @@index([flag])
  @@index([createdAt])
}

// ============================================
// Phase 4: 自动化规则与统计
// ============================================

// 自动化规则配置
model AutomationRule {
  id          Int      @id @default(autoincrement())
  instanceId  Int
  instance    Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  
  // 规则类型
  type        String   // 'blacklist' | 'whitelist' | 'keyword'
  target      String   // 'friend' | 'group' | 'all'
  
  // 条件配置 (JSON)
  conditions  Json     // { userIds: [], keywords: [] }
  
  // 动作
  action      String   // 'approve' | 'reject'
  reason      String?  // 自动拒绝理由
  
  // 状态
  enabled     Boolean  @default(true)
  priority    Int      @default(0)  // 优先级，数字越大优先级越高
  
  // 统计
  matchCount  Int      @default(0)
  
  // 时间戳
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([instanceId, enabled])
  @@index([type, target])
}

// 请求统计汇总
model RequestStatistics {
  id              Int      @id @default(autoincrement())
  instanceId      Int      @unique
  instance        Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  
  // 好友申请统计
  friendTotal     Int      @default(0)
  friendPending   Int      @default(0)
  friendApproved  Int      @default(0)
  friendRejected  Int      @default(0)
  
  // 加群申请统计
  groupTotal      Int      @default(0)
  groupPending    Int      @default(0)
  groupApproved   Int      @default(0)
  groupRejected   Int      @default(0)
  
  // 最后更新
  updatedAt       DateTime @updatedAt
}
