import type { UnifiedMessage } from '../../../domain/message';
import { CommandContext } from './CommandContext';
import { getLogger } from '../../../shared/logger';

const logger = getLogger('QuotLyCommandHandler');

/**
 * QuotLy å‘½ä»¤å¤„ç†å™¨
 * ç”Ÿæˆ QuotLy é£æ ¼çš„å¼•ç”¨å›¾ç‰‡
 */
export class QuotLyCommandHandler {
    constructor(private readonly context: CommandContext) { }

    async execute(msg: UnifiedMessage, args: string[]): Promise<void> {
        // åªåœ¨ Telegram ç«¯å¤„ç†
        if (msg.platform !== 'telegram') {
            return;
        }

        const chatId = msg.chat.id;
        const threadId = this.context.extractThreadId(msg, args);
        const raw = (msg.metadata as any)?.raw as any;

        // æ£€æŸ¥æ˜¯å¦å›å¤äº†æŸæ¡æ¶ˆæ¯
        const replyToId = raw?.replyTo?.replyToMsgId
            || raw?.replyTo?.id
            || raw?.replyToMessage?.id;

        if (!replyToId) {
            await this.context.replyTG(
                chatId,
                'è¯·å›å¤è¦ç”Ÿæˆ QuotLy å›¾ç‰‡çš„æ¶ˆæ¯å†ä½¿ç”¨ /q å‘½ä»¤',
                threadId
            );
            return;
        }

        try {
            await this.context.replyTG(chatId, 'ğŸ¨ æ­£åœ¨ç”Ÿæˆ QuotLy å›¾ç‰‡...', threadId);

            // TODO: å®ç° QuotLy ç”Ÿæˆé€»è¾‘
            // æ–¹æ¡ˆ 1: ä½¿ç”¨ QuotLy å®˜æ–¹ API (https://quotly.netorare.codes/)
            // æ–¹æ¡ˆ 2: ä½¿ç”¨æœ¬åœ°å›¾ç‰‡åˆæˆï¼ˆcanvas/sharpï¼‰
            // æ–¹æ¡ˆ 3: ä½¿ç”¨ Puppeteer æˆªå›¾

            // ä¸´æ—¶å®ç°ï¼šè¿”å›æç¤ºä¿¡æ¯
            await this.context.replyTG(
                chatId,
                `âš ï¸ QuotLy åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­\n\n` +
                `è®¡åˆ’å®ç°æ–¹å¼:\n` +
                `1. ä½¿ç”¨ QuotLy API ç”Ÿæˆå¼•ç”¨å›¾ç‰‡\n` +
                `2. è‡ªå®šä¹‰æ ·å¼å’Œä¸»é¢˜\n` +
                `3. æ”¯æŒå¤šè¯­è¨€\n\n` +
                `æ•¬è¯·æœŸå¾…ï¼`,
                threadId
            );

            logger.info(`QuotLy generation requested for message ${replyToId} in chat ${chatId}`);

            // ç¤ºä¾‹ä»£ç ï¼ˆæœªå®ç°ï¼‰:
            // const quotlyImage = await this.generateQuotLy(replyToId, chatId);
            // const tgChat = await this.context.tgBot.getChat(Number(chatId));
            // await tgChat.sendPhoto(quotlyImage, {
            //     caption: 'Generated by QuotLy',
            //     replyTo: threadId,
            // });

        } catch (error) {
            logger.error('Failed to generate QuotLy:', error);
            await this.context.replyTG(chatId, 'âŒ ç”Ÿæˆ QuotLy å›¾ç‰‡å¤±è´¥', threadId);
        }
    }

    /**
     * ç”Ÿæˆ QuotLy å›¾ç‰‡
     * TODO: å®ç°å®é™…çš„ç”Ÿæˆé€»è¾‘
     */
    private async generateQuotLy(messageId: number, chatId: string): Promise<Buffer> {
        // æ–¹æ¡ˆ 1: è°ƒç”¨ QuotLy API
        // const response = await fetch('https://quotly.netorare.codes/generate', {
        //     method: 'POST',
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify({
        //         type: 'quote',
        //         messages: [messageData],
        //     }),
        // });
        // return Buffer.from(await response.arrayBuffer());

        // æ–¹æ¡ˆ 2: æœ¬åœ°ç”Ÿæˆ
        // const { createCanvas, loadImage } = require('canvas');
        // const canvas = createCanvas(800, 400);
        // const ctx = canvas.getContext('2d');
        // ... ç»˜åˆ¶é€»è¾‘ ...
        // return canvas.toBuffer();

        throw new Error('QuotLy generation not implemented');
    }
}
