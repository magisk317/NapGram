name: Security - Secret Scanning

on:
  push:
    branches: [dev, main]
  pull_request:
    branches: [dev, main]
  workflow_dispatch:

jobs:
  gitleaks:
    name: ðŸ”’ Scan for Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # å®Œæ•´åŽ†å²ï¼Œç”¨äºŽæ‰«ææ‰€æœ‰ commit

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # å¯é€‰ï¼Œä¼ä¸šç‰ˆæ‰éœ€è¦

  trufflehog:
    name: ðŸ” TruffleHog Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  custom-patterns:
    name: ðŸŽ¯ Custom Pattern Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for sensitive files
        run: |
          echo "ðŸ” æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶..."
          
          # å®šä¹‰ä¸åº”æäº¤çš„æ–‡ä»¶åˆ—è¡¨
          SENSITIVE_FILES=(
            "compose.stable.yaml"
            "compose.dev.yaml"
            ".env"
            ".env.local"
            ".env.*.local"
          )
          
          FOUND_FILES=()
          for file in "${SENSITIVE_FILES[@]}"; do
            if git ls-files | grep -q "^${file}$"; then
              FOUND_FILES+=("$file")
            fi
          done
          
          if [ ${#FOUND_FILES[@]} -gt 0 ]; then
            echo "âŒ é”™è¯¯ï¼šå‘çŽ°ä¸åº”æäº¤çš„æ•æ„Ÿæ–‡ä»¶ï¼š"
            printf '  - %s\n' "${FOUND_FILES[@]}"
            echo ""
            echo "è¿™äº›æ–‡ä»¶åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œä¸åº”æäº¤åˆ° gitã€‚"
            echo "è¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç§»é™¤ï¼š"
            echo ""
            for file in "${FOUND_FILES[@]}"; do
              echo "  git rm --cached ${file}"
            done
            exit 1
          fi
          
          echo "âœ… æœªå‘çŽ°æ•æ„Ÿæ–‡ä»¶"

      - name: Check for hardcoded secrets in code
        run: |
          echo "ðŸ” æ£€æŸ¥ç¡¬ç¼–ç çš„å¯†é’¥..."
          
          # æ£€æŸ¥å¸¸è§çš„å¯†é’¥æ¨¡å¼
          PATTERNS=(
            # Telegram Bot Token
            "TG_BOT_TOKEN.*[0-9]{10}:[A-Za-z0-9_-]{35}"
            # Telegram API Hash (32ä½åå…­è¿›åˆ¶)
            "TG_API_HASH.*[0-9a-f]{32}"
            # API Keys
            "api[_-]?key.*['\"][0-9a-zA-Z]{32,}['\"]"
            # Access Token
            "access[_-]?token.*['\"][0-9a-zA-Z]{32,}['\"]"
            # Private keys
            "-----BEGIN (RSA |DSA )?PRIVATE KEY-----"
            # AWS
            "AKIA[0-9A-Z]{16}"
          )
          
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if git diff --cached | grep -iE "$pattern"; then
              echo "âŒ å‘çŽ°å¯ç–‘æ¨¡å¼: $pattern"
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 1 ]; then
            echo ""
            echo "âŒ åœ¨ä»£ç ä¸­å‘çŽ°å¯èƒ½çš„ç¡¬ç¼–ç å¯†é’¥ï¼"
            echo "è¯·ä½¿ç”¨çŽ¯å¢ƒå˜é‡æ›¿ä»£ç¡¬ç¼–ç çš„å¯†é’¥ã€‚"
            exit 1
          fi
          
          echo "âœ… æœªå‘çŽ°ç¡¬ç¼–ç å¯†é’¥"

  # å¯é€‰ï¼šæ£€æŸ¥ PR ä¸­çš„æ•æ„Ÿä¿¡æ¯
  pr-check:
    name: ðŸ“ PR Diff Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check PR diff for secrets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” æ£€æŸ¥ PR å˜æ›´..."
          
          # èŽ·å– PR çš„å·®å¼‚
          git fetch origin ${{ github.base_ref }}
          
          # æ£€æŸ¥æ–°å¢žçš„è¡Œ
          SUSPICIOUS_LINES=$(git diff origin/${{ github.base_ref }}...HEAD | grep "^+" | grep -iE "(token|password|secret|key|hash).*[:=].*['\"]")
          
          if [ ! -z "$SUSPICIOUS_LINES" ]; then
            echo "âš ï¸ åœ¨ PR ä¸­å‘çŽ°å¯ç–‘çš„æ–°å¢žè¡Œï¼š"
            echo "$SUSPICIOUS_LINES"
            echo ""
            echo "è¯·ç¡®è®¤è¿™äº›ä¸æ˜¯æ•æ„Ÿä¿¡æ¯ã€‚"
            echo "å¦‚æžœæ˜¯é…ç½®ç¤ºä¾‹ï¼Œè¯·ä½¿ç”¨å ä½ç¬¦ï¼ˆå¦‚ 'YOUR_TOKEN_HERE'ï¼‰"
            # æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯è­¦å‘Šï¼Œä¸ä¼šä½¿ CI å¤±è´¥
            # å¦‚æžœè¦å¼ºåˆ¶å¤±è´¥ï¼Œå–æ¶ˆä¸‹é¢è¿™è¡Œçš„æ³¨é‡Šï¼š
            # exit 1
          else
            echo "âœ… PR æ£€æŸ¥é€šè¿‡"
          fi

  report:
    name: ðŸ“Š Security Report
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, custom-patterns]
    if: always()
    steps:
      - name: Generate Report
        run: |
          echo "## ðŸ›¡ï¸ å®‰å…¨æ‰«ææŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.gitleaks.result }}" == "success" ]; then
            echo "âœ… Gitleaks: æœªå‘çŽ°æ³„éœ²" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Gitleaks: å‘çŽ°é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.trufflehog.result }}" == "success" ]; then
            echo "âœ… TruffleHog: æœªå‘çŽ°æ³„éœ²" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ TruffleHog: å‘çŽ°é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.custom-patterns.result }}" == "success" ]; then
            echo "âœ… è‡ªå®šä¹‰æ£€æŸ¥: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ è‡ªå®šä¹‰æ£€æŸ¥: å‘çŽ°é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ‰«ææ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
