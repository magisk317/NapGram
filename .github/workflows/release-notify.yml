name: Release Notifications

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  notify-release:
    name: Notify New Release
    runs-on: ubuntu-latest
    steps:
      - name: Process Release Body
        id: process_body
        env:
          RAW_BODY: ${{ github.event.release.body }}
        run: |
          BODY="$RAW_BODY"
          
          # Convert GFM to Telegram HTML
          # 1. Bold: **text** -> <b>text</b>
          BODY=$(echo "$BODY" | sed -E 's/\*\*([^*]+)\*\*/<b>\1<\/b>/g')
          # 2. Code: `text` -> <code>text</code>
          BODY=$(echo "$BODY" | sed -E 's/`([^`]+)`/<code>\1<\/code>/g')
          # 3. Headers: ### Text -> <b>Text</b>
          BODY=$(echo "$BODY" | sed -E 's/^#{1,6} (.*)$/<b>\1<\/b>/')
          
          MAX_LENGTH=1500
          
          if [ ${#BODY} -gt $MAX_LENGTH ]; then
            # Truncate to max length
            TRUNCATED="${BODY:0:$MAX_LENGTH}"
            # Trim to last space to avoid cutting words
            FINAL_BODY="${TRUNCATED% *}..."
            
            echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
            echo "$FINAL_BODY" >> $GITHUB_ENV
            echo "" >> $GITHUB_ENV
            echo "<i>ÔºàÂÜÖÂÆπËøáÈïøÔºå‰ªÖÊòæÁ§∫ÂâçÈÉ®ÂàÜÔºâ</i>" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
            echo "$BODY" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      - name: Send Telegram Notification to Group Topic
        env:
          MESSAGE: |
            üöÄ New Release: ${{ github.event.release.tag_name }}
            
            ${{ env.RELEASE_BODY }}
            
            Link: ${{ github.event.release.html_url }}
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_TO_GROUP }} \
          -d message_thread_id=${{ secrets.TELEGRAM_RELEASE_TOPIC_ID }} \
          -d parse_mode=HTML \
          --data-urlencode "text=$MESSAGE"

      - name: Send Telegram Notification to Channel
        env:
          MESSAGE: |
            üöÄ New Release: ${{ github.event.release.tag_name }}
            
            ${{ env.RELEASE_BODY }}
            
            Link: ${{ github.event.release.html_url }}
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_TO_CHANNEL }} \
          -d parse_mode=HTML \
          --data-urlencode "text=$MESSAGE"
