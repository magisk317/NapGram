name: Release Notifications

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: Release tag (e.g. v1.2.3)
        required: true
      html_url:
        description: Release URL (optional)
        required: false
      body:
        description: Release body (optional)
        required: false

permissions:
  contents: read

jobs:
  notify-release:
    name: Notify New Release
    runs-on: ubuntu-latest
    steps:
      - name: Prepare Notification Context
        env:
          TAG_NAME: ${{ github.event_name == 'release' && github.event.release.tag_name || github.event.inputs.tag_name }}
          HTML_URL: ${{ github.event_name == 'release' && github.event.release.html_url || github.event.inputs.html_url }}
          BODY: ${{ github.event_name == 'release' && github.event.release.body || github.event.inputs.body }}
        run: |
          set -euo pipefail

          tag="${TAG_NAME:-${GITHUB_REF_NAME:-manual}}"
          url="${HTML_URL:-https://github.com/${GITHUB_REPOSITORY}/releases/tag/${tag}}"

          echo "RELEASE_TAG=$tag" >> "$GITHUB_ENV"
          echo "RELEASE_URL=$url" >> "$GITHUB_ENV"
          echo "RAW_BODY<<EOF" >> "$GITHUB_ENV"
          echo "${BODY:-}" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

      - name: Prepare Release Body
        run: |
          set -euo pipefail
          
          # ç›´æŽ¥ä½¿ç”¨åŽŸå§‹bodyï¼Œæˆªæ–­è¿‡é•¿å†…å®¹
          BODY="${RAW_BODY:-}"
          MAX_LENGTH=800
          
          if [ ${#BODY} -gt $MAX_LENGTH ]; then
            TRUNCATED="${BODY:0:$MAX_LENGTH}"
            FINAL_BODY="${TRUNCATED% *}..."
            echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
            echo "$FINAL_BODY" >> $GITHUB_ENV
            echo "" >> $GITHUB_ENV
            echo "(å†…å®¹è¿‡é•¿ï¼Œä»…æ˜¾ç¤ºå‰éƒ¨åˆ†)" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
            echo "$BODY" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      - name: Send Telegram Notification to Group Topic
        env:
          MESSAGE: |
            ðŸš€ New Release: ${{ env.RELEASE_TAG }}
            
            ${{ env.RELEASE_BODY }}
            
            Link: ${{ env.RELEASE_URL }}
        run: |
          curl -fSs -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_TO_GROUP }}" \
            -d "message_thread_id=${{ secrets.TELEGRAM_RELEASE_TOPIC_ID }}" \
            --data-urlencode "text=$MESSAGE"

      - name: Send Telegram Notification to Channel
        env:
          MESSAGE: |
            ðŸš€ New Release: ${{ env.RELEASE_TAG }}
            
            ${{ env.RELEASE_BODY }}
            
            Link: ${{ env.RELEASE_URL }}
        run: |
          curl -fSs -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_TO_CHANNEL }}" \
            --data-urlencode "text=$MESSAGE"
