name: Release Notifications

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  notify-release:
    name: Notify New Release
    runs-on: ubuntu-latest
    steps:
      - name: Process Release Body
        id: process_body
        env:
          RAW_BODY: ${{ github.event.release.body }}
        run: |
          BODY="$RAW_BODY"
          
          # Convert GFM to Telegram Markdown
          # 1. Bold: **text** -> *text*
          BODY=$(echo "$BODY" | sed 's/\*\*/\*/g')
          # 2. Headers: # Text -> *Text*
          BODY=$(echo "$BODY" | sed -E 's/^#{1,6} (.*)$/*\1*/')
          
          MAX_LENGTH=1500
          
          if [ ${#BODY} -gt $MAX_LENGTH ]; then
            # Truncate to max length
            TRUNCATED="${BODY:0:$MAX_LENGTH}"
            # Trim to last space to avoid cutting words
            FINAL_BODY="${TRUNCATED% *}..."
            
            echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
            echo "$FINAL_BODY" >> $GITHUB_ENV
            echo "" >> $GITHUB_ENV
            echo "_ï¼ˆå†…å®¹è¿‡é•¿ï¼Œä»…æ˜¾ç¤ºå‰éƒ¨åˆ†ï¼‰_" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
            echo "$BODY" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      - name: Send Telegram Notification to Group Topic
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO_GROUP }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message_thread_id: ${{ secrets.TELEGRAM_RELEASE_TOPIC_ID }}
          format: markdown
          message: |
            ðŸš€ New Release: ${{ github.event.release.tag_name }}
            
            ${{ env.RELEASE_BODY }}
            
            Link: ${{ github.event.release.html_url }}

      - name: Send Telegram Notification to Channel
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO_CHANNEL }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            ðŸš€ New Release: ${{ github.event.release.tag_name }}
            
            ${{ env.RELEASE_BODY }}
            
            Link: ${{ github.event.release.html_url }}
